<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ - Asistente Musical</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background: #1a1a1a;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            padding: 12px 15px;
            max-width: 85%;
            line-height: 1.4;
        }
        
        .user {
            background: #2a2a2a;
            align-self: flex-end;
            text-align: right;
        }
        
        .assistant {
            background: #1a4d2e;
            align-self: flex-start;
        }
        
        .loading {
            background: #1a1a1a;
            align-self: flex-start;
            color: #888;
        }
        
        #input-area {
            background: #1a1a1a;
            padding: 12px;
            display: flex;
            gap: 8px;
            border-top: 1px solid #333;
        }
        
        #user-input {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            font-size: 16px;
            outline: none;
        }
        
        #send-btn {
            background: #1a4d2e;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            min-width: 60px;
        }
        
        #send-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>DJ - Asistente Musical</h1>
    </div>
    
    <div id="messages">
        <div class="message assistant">
            Hola, soy DJ, tu asistente musical. ¿Qué música te gustaría escuchar hoy?
        </div>
    </div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Escribe tu mensaje..." autocomplete="off">
        <button id="send-btn">Enviar</button>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let conversationHistory = [];
        let musicData = null;

        const DJ_SYSTEM_PROMPT = `Eres una inteligencia artificial llamada DJ, especializada exclusivamente en música. Tienes la capacidad de consultar una base de datos simulada de YouTube Music mediante solicitudes a una URL que devuelve información en formato JSON.

Tu tarea es interpretar correctamente la solicitud del usuario, construir la URL adecuada, leer y comprender la estructura del JSON recibido y generar una respuesta musical coherente, útil y precisa basada en esos datos.

Estás entrenado únicamente para actuar como DJ musical, por lo que debes evitar hablar de cualquier tema que no esté relacionado con la música (artistas, canciones, álbumes, géneros, estados de ánimo musicales, playlists, recomendaciones, etc.).

Tu personalidad es alegre, cercana y amable, conectas con el usuario de forma natural y fluida, sin mencionar explícitamente que estás siguiendo reglas o procesos internos.

Responde siempre con un tono cálido y entusiasta, como un DJ profesional que conoce perfectamente los gustos musicales del oyente.

IMPORTANTE: Nunca uses emojis en tus respuestas. Mantén un tono profesional y enfocado únicamente en la información musical.`;

        function addMessage(role, content) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.textContent = content;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading';
            loadingDiv.id = 'loading-msg';
            loadingDiv.textContent = 'DJ está buscando música...';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loadingMsg = document.getElementById('loading-msg');
            if (loadingMsg) loadingMsg.remove();
        }

        async function loadMusicData() {
            try {
                const response = await fetch('https://braided-music-1--noreplyscuritym.replit.app/api/home');
                musicData = await response.json();
            } catch (error) {
                console.error('Error cargando datos musicales:', error);
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            userInput.value = '';
            sendBtn.disabled = true;
            showLoading();

            conversationHistory.push({
                role: 'user',
                content: message
            });

            try {
                await loadMusicData();
                
                let contextMessage = message;
                if (musicData) {
                    contextMessage = `${message}\n\nDatos musicales disponibles de YouTube Music:\n${JSON.stringify(musicData)}`;
                }

                const messages = [
                    ...conversationHistory.slice(0, -1),
                    {
                        role: 'user',
                        content: contextMessage
                    }
                ];

                const response = await puter.ai.chat(
                    messages,
                    {
                        model: 'claude-3.5-sonnet',
                        system: DJ_SYSTEM_PROMPT
                    }
                );

                hideLoading();

                if (response && response.message && response.message.content) {
                    const assistantMessage = response.message.content;
                    addMessage('assistant', assistantMessage);
                    
                    conversationHistory.push({
                        role: 'assistant',
                        content: assistantMessage
                    });
                } else {
                    addMessage('assistant', 'Lo siento, hubo un error. ¿Podrías intentarlo de nuevo?');
                }
            } catch (error) {
                hideLoading();
                addMessage('assistant', 'Ups, algo salió mal. Por favor intenta de nuevo.');
                console.error('Error:', error);
            }

            sendBtn.disabled = false;
            userInput.focus();
        }

        sendBtn.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        loadMusicData();
        userInput.focus();
    </script>
</body>
</html>