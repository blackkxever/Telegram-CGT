<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Music App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css">
  <style>
    :root {
      --bg: #000;
      --surface: #161616;
      --surface-hover: #1f1f1f;
      --text: #fff;
      --text-secondary: #a0a0a0;
      --accent: #1ed760;
      --accent-text: #000;
      --font: 'Google Sans Flex', -apple-system, sans-serif;
      --text-xs: 11px;
      --text-sm: 13px;
      --text-base: 15px;
      --text-lg: 18px;
      --text-xl: 24px;
      --text-2xl: 28px;
      --weight-regular: 400;
      --weight-medium: 500;
      --weight-semibold: 600;
      --weight-bold: 700;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --radius-xs: 2px;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      --icon-sm: 20px;
      --icon-md: 24px;
      --icon-lg: 28px;
      --touch-target: 44px;
      --touch-target-lg: 52px;
      --thumb-sm: 48px;
      --thumb-md: 136px;
      --thumb-lg: 200px;
      --nav-height: 72px;
      --header-height: 56px;
      --z-base: 1;
      --z-nav: 100;
      --z-header: 110;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: var(--bg);
      font-family: var(--font);
      color: var(--text);
      font-size: var(--text-base);
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      padding-top: var(--safe-top);
    }

    button {
      appearance: none;
      background: transparent;
      border: none;
      outline: none;
      cursor: pointer;
      font-family: inherit;
    }

    img {
      display: block;
      max-width: 100%;
    }

    .container {
      min-height: 100dvh;
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
    }

    .fixed-header {
      position: fixed;
      top: var(--safe-top);
      left: 0;
      right: 0;
      z-index: var(--z-nav);
      background: var(--bg);
    }

    .home-top-bar {
      transform: translateY(0);
      transition: transform 0.25s ease-out;
    }

    .home-top-bar.hidden {
      transform: translateY(-100%);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      gap: var(--space-3);
      min-height: var(--header-height);
    }

    .header-content {
      flex: 1;
      min-width: 0;
    }

    .header-title {
      font-size: var(--text-xl);
      font-weight: var(--weight-bold);
      line-height: 1.2;
    }

    .header-actions {
      display: flex;
      gap: var(--space-1);
      align-items: center;
    }

    .header-spacer {
      height: 0;
    }

    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      color: var(--text);
      border-radius: var(--radius-full);
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    .icon-btn:active {
      transform: scale(0.92);
      opacity: 0.7;
    }

    .icon-btn i {
      font-size: var(--icon-md);
    }

    .tabs-wrapper {
      padding: 0 0 var(--space-3);
    }

    .tabs-container {
      display: flex;
      gap: var(--space-2);
      padding: 0 var(--space-4);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tabs-container::-webkit-scrollbar {
      display: none;
    }

    .tab {
      display: inline-flex;
      align-items: center;
      padding: 0 var(--space-4);
      height: 36px;
      background: var(--surface);
      color: var(--text);
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      border-radius: var(--radius-full);
      white-space: nowrap;
      flex-shrink: 0;
      transition: transform 0.15s ease, background-color 0.2s ease, color 0.2s ease;
    }

    .tab:active {
      transform: scale(0.95);
    }

    .tab.active {
      background: var(--accent);
      color: var(--accent-text);
      font-weight: var(--weight-semibold);
    }

    .section {
      margin-bottom: var(--space-6);
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      padding: 0 var(--space-4);
      margin-bottom: var(--space-3);
    }

    .section-subtitle {
      font-size: var(--text-xs);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      line-height: 1.3;
      margin-bottom: var(--space-1);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--weight-bold);
      line-height: 1.25;
    }

    .section-items {
      display: flex;
      gap: var(--space-3);
      padding: 0 var(--space-4);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .section-items::-webkit-scrollbar {
      display: none;
    }

    .item-card {
      display: flex;
      flex-direction: column;
      width: min-content;
      min-width: var(--thumb-md);
      flex-shrink: 0;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .item-card:active {
      transform: scale(0.97);
      opacity: 0.8;
    }

    .item-image {
      height: var(--thumb-md);
      width: auto;
      max-width: none;
      min-width: var(--thumb-md);
      border-radius: var(--radius-md);
      object-fit: cover;
      margin-bottom: var(--space-3);
      flex-shrink: 0;
    }

    .item-info {
      width: 0;
      min-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .item-title {
      font-size: var(--text-base);
      font-weight: var(--weight-medium);
      line-height: 1.35;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .item-meta {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.35;
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .item-meta-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .explicit-badge {
      width: 16px;
      height: 16px;
      min-width: 16px;
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-secondary);
      border-radius: var(--radius-xs);
      font-size: 9px;
      font-weight: var(--weight-bold);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .shimmer {
      background: linear-gradient(90deg, var(--surface) 0%, var(--surface) 40%, #222 50%, var(--surface) 60%, var(--surface) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .shimmer-tab {
      height: 36px;
      border-radius: var(--radius-full);
    }

    .shimmer-title {
      width: 120px;
      height: 22px;
      border-radius: var(--radius-sm);
    }

    .shimmer-text {
      height: 20px;
      border-radius: var(--radius-sm);
      margin-bottom: 2px;
    }

    .shimmer-text-sm {
      height: 18px;
      border-radius: var(--radius-sm);
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: var(--z-nav);
      display: flex;
      justify-content: space-around;
      padding: var(--space-2) var(--space-4) calc(var(--space-2) + var(--safe-bottom));
      min-height: var(--nav-height);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: var(--space-2);
      color: var(--text-secondary);
      flex: 1;
      max-width: 80px;
      transition: color 0.2s ease, transform 0.15s ease;
    }

    .nav-item:active {
      transform: scale(0.9);
    }

    .nav-item.active {
      color: var(--text);
    }

    .nav-item i {
      font-size: var(--icon-md);
      transition: transform 0.2s ease;
    }

    .nav-item.active i {
      transform: scale(1.05);
    }

    .nav-item-label {
      font-size: var(--text-xs);
      font-weight: var(--weight-medium);
      line-height: 1;
    }

    .detail-view {
      min-height: 100dvh;
      background: var(--bg);
      display: none;
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
    }

    .detail-header {
      position: relative;
      overflow: hidden;
      padding-top: 64px;
    }

    .detail-nav {
      position: fixed;
      top: var(--safe-top);
      left: 0;
      right: 0;
      z-index: var(--z-header);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-4);
      height: 64px;
      background: transparent;
      transition: background-color 0.2s ease;
    }

    .detail-nav-title {
      flex: 1;
      margin: 0 var(--space-3);
      font-size: var(--text-base);
      font-weight: var(--weight-bold);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .detail-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
      background-size: cover;
      background-position: center;
      filter: blur(24px);
      transform: scale(1.2);
    }

    .detail-bg-shimmer {
      position: absolute;
      inset: 0;
      z-index: var(--z-base);
    }

    .detail-gradient {
      position: absolute;
      inset: 0;
      z-index: var(--z-base);
      background: linear-gradient(180deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.5) 30%, rgba(0,0,0,0.8) 60%, #000 100%);
    }

    .detail-cover-wrap {
      position: relative;
      z-index: var(--z-base);
      display: flex;
      justify-content: center;
      padding: 0 var(--space-4);
    }

    .detail-cover {
      width: var(--thumb-lg);
      height: var(--thumb-lg);
      border-radius: var(--radius-md);
      object-fit: cover;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      animation: coverFadeIn 0.4s ease;
    }

    @keyframes coverFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .detail-info {
      padding: var(--space-4) var(--space-4) 0;
      background: var(--bg);
    }

    .detail-title {
      font-size: var(--text-2xl);
      font-weight: var(--weight-bold);
      line-height: 1.15;
      margin-bottom: var(--space-2);
    }

    .detail-meta {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.45;
      max-height: 2.9em;
      overflow: hidden;
    }

    .detail-meta.expanded {
      max-height: none;
    }

    .detail-meta-expand {
      color: var(--text);
      font-weight: var(--weight-semibold);
      transition: opacity 0.15s ease;
    }

    .detail-meta-expand:active {
      opacity: 0.6;
    }

    .detail-actions {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-4);
      background: var(--bg);
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      color: var(--text);
      border-radius: var(--radius-full);
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    .action-btn:active {
      transform: scale(0.9);
      opacity: 0.7;
    }

    .action-btn i {
      font-size: var(--icon-lg);
    }

    .action-btn-shuffle {
      margin-left: auto;
    }

    .action-btn-play {
      width: var(--touch-target-lg);
      height: var(--touch-target-lg);
      margin-left: var(--space-3);
      background: var(--accent);
      color: var(--accent-text);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 16px rgba(30, 215, 96, 0.3);
    }

    .action-btn-play:active {
      transform: scale(0.92);
      opacity: 1;
      box-shadow: 0 2px 8px rgba(30, 215, 96, 0.4);
    }

    .action-btn-play i {
      font-size: 28px;
    }

    .track-list {
      padding: 0 var(--space-4);
      background: var(--bg);
    }

    .track-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) 0;
      border-radius: var(--radius-md);
      margin: 0 calc(var(--space-2) * -1);
      padding-left: var(--space-2);
      padding-right: var(--space-2);
      transition: background-color 0.15s ease;
    }

    .track-item:active {
      background-color: var(--surface);
    }

    .track-thumb {
      width: var(--thumb-sm);
      height: var(--thumb-sm);
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
    }

    .track-num {
      width: var(--thumb-sm);
      height: var(--thumb-sm);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-size: var(--text-base);
      font-weight: var(--weight-medium);
      line-height: 1.35;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .track-artist {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.35;
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .track-artist-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .track-menu {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: var(--touch-target);
      height: var(--touch-target);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      transition: transform 0.15s ease, color 0.15s ease;
    }

    .track-menu:active {
      transform: scale(0.85);
      color: var(--text);
    }

    .track-menu i {
      font-size: var(--icon-sm);
    }

    .search-view {
      min-height: 100dvh;
      background: var(--bg);
      display: none;
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
    }

    .search-input-wrap {
      padding: 0 var(--space-4) var(--space-3);
    }

    .search-input-box {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      height: var(--touch-target);
      padding: 0 var(--space-3);
      background: var(--surface);
      border-radius: var(--radius-md);
    }

    .search-icon {
      color: var(--text-secondary);
      margin-right: var(--space-2);
      font-size: var(--icon-sm);
    }

    .search-input {
      flex: 1;
      height: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: var(--font);
      font-size: var(--text-base);
      font-weight: var(--weight-medium);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .floating-play {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + var(--space-3));
      right: var(--space-4);
      z-index: calc(var(--z-nav) - 1);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      height: var(--touch-target);
      padding: 0 var(--space-4);
      background: var(--accent);
      border-radius: var(--radius-full);
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px) scale(0.95);
      transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 20px rgba(30, 215, 96, 0.35);
    }

    .floating-play.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }

    .floating-play:active {
      transform: translateY(0) scale(0.95);
      box-shadow: 0 2px 12px rgba(30, 215, 96, 0.4);
    }

    .floating-play i {
      font-size: var(--icon-sm);
      color: var(--accent-text);
    }

    .floating-play span {
      font-size: var(--text-base);
      font-weight: var(--weight-semibold);
      color: var(--accent-text);
    }
  </style>
</head>
<body>
  <div class="container" id="homeView">
    <div id="homeTopBar" class="fixed-header home-top-bar">
      <header class="header">
        <div class="header-content">
          <h1 class="header-title">Buenos días</h1>
        </div>
        <div class="header-actions">
          <button class="icon-btn" aria-label="Notificaciones" type="button">
            <i class="ph-bold ph-bell"></i>
          </button>
          <button class="icon-btn" aria-label="Configuración" type="button">
            <i class="ph-bold ph-gear"></i>
          </button>
        </div>
      </header>
      <div class="tabs-wrapper">
        <div class="tabs-container" id="tabs"></div>
      </div>
    </div>
    <div class="header-spacer"></div>
    <main id="content"></main>
  </div>

  <div class="container" id="exploreView" style="display: none;">
    <div class="fixed-header">
      <header class="header">
        <div class="header-content">
          <h1 class="header-title">Explorar</h1>
        </div>
        <div class="header-actions">
          <button class="icon-btn" aria-label="Notificaciones" type="button">
            <i class="ph-bold ph-bell"></i>
          </button>
          <button class="icon-btn" aria-label="Configuración" type="button">
            <i class="ph-bold ph-gear"></i>
          </button>
        </div>
      </header>
    </div>
    <div class="header-spacer"></div>
    <main id="exploreContent"></main>
  </div>

  <div class="detail-view" id="detailView">
    <div class="detail-header">
      <div class="detail-bg" id="detailBackground"></div>
      <div class="detail-gradient"></div>
      <div class="detail-nav">
        <button class="icon-btn" aria-label="Volver" id="backButton" type="button">
          <i class="ph-bold ph-caret-left"></i>
        </button>
        <span class="detail-nav-title" id="detailHeaderTitle"></span>
        <button class="icon-btn" aria-label="Buscar" type="button">
          <i class="ph-bold ph-magnifying-glass"></i>
        </button>
      </div>
      <div class="detail-cover-wrap" id="detailCoverContainer"></div>
    </div>
    <div class="detail-info">
      <h1 class="detail-title" id="detailTitle"></h1>
      <div class="detail-meta" id="detailMeta"></div>
    </div>
    <div class="detail-actions">
      <button class="action-btn" aria-label="Agregar" type="button">
        <i class="ph-bold ph-plus-circle"></i>
      </button>
      <button class="action-btn" aria-label="Descargar" type="button">
        <i class="ph-bold ph-download-simple"></i>
      </button>
      <button class="action-btn" aria-label="Más opciones" type="button">
        <i class="ph-bold ph-dots-three"></i>
      </button>
      <button class="action-btn action-btn-shuffle" aria-label="Aleatorio" type="button">
        <i class="ph-bold ph-shuffle"></i>
      </button>
      <button class="action-btn action-btn-play" aria-label="Reproducir" type="button">
        <i class="ph-fill ph-play"></i>
      </button>
    </div>
    <div class="track-list" id="trackList"></div>
  </div>

  <div class="search-view" id="searchView">
    <div class="fixed-header">
      <header class="header">
        <div class="header-content">
          <h1 class="header-title">Buscar</h1>
        </div>
        <div class="header-actions">
          <button class="icon-btn" aria-label="Cámara" type="button">
            <i class="ph-bold ph-camera"></i>
          </button>
        </div>
      </header>
      <div class="search-input-wrap">
        <div class="search-input-box">
          <i class="ph-bold ph-magnifying-glass search-icon"></i>
          <input type="text" class="search-input" id="searchInput" placeholder="¿Qué quieres escuchar?">
        </div>
      </div>
    </div>
    <div class="header-spacer"></div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <button class="floating-play" id="floatingPlay" aria-label="Reproducir" type="button">
    <i class="ph-fill ph-play"></i>
    <span>Reproducir</span>
  </button>

  <nav class="bottom-nav">
    <button class="nav-item active" data-view="home" aria-label="Inicio" type="button">
      <i class="ph-fill ph-house"></i>
      <span class="nav-item-label">Inicio</span>
    </button>
    <button class="nav-item" data-view="search" aria-label="Buscar" type="button">
      <i class="ph-bold ph-magnifying-glass"></i>
      <span class="nav-item-label">Buscar</span>
    </button>
    <button class="nav-item" data-view="explore" aria-label="Explorar" type="button">
      <i class="ph-bold ph-compass"></i>
      <span class="nav-item-label">Explorar</span>
    </button>
    <button class="nav-item" data-view="library" aria-label="Tu biblioteca" type="button">
      <i class="ph-bold ph-books"></i>
      <span class="nav-item-label">Biblioteca</span>
    </button>
  </nav>

  <script>
    const API = 'https://braided-music-1--noreplyscuritym.replit.app/api';
    let currentFilter = null;
    let sectionItemCounters = {};

    const iconStates = {
      home: { filled: 'ph-fill ph-house', outline: 'ph-bold ph-house' },
      search: { filled: 'ph-fill ph-magnifying-glass', outline: 'ph-bold ph-magnifying-glass' },
      explore: { filled: 'ph-fill ph-compass', outline: 'ph-bold ph-compass' },
      library: { filled: 'ph-fill ph-books', outline: 'ph-bold ph-books' }
    };

    const addTapHandler = (el, handler) => {
      let startX = 0, startY = 0, isScrolling = false;
      el.addEventListener('touchstart', e => {
        startX = e.changedTouches[0].pageX;
        startY = e.changedTouches[0].pageY;
        isScrolling = false;
      }, { passive: true });
      el.addEventListener('touchend', e => {
        const diffX = Math.abs(e.changedTouches[0].pageX - startX);
        const diffY = Math.abs(e.changedTouches[0].pageY - startY);
        if (diffX > 10 || diffY > 10) { isScrolling = true; return; }
        e.preventDefault();
        handler(e);
      });
      el.addEventListener('click', e => {
        if (isScrolling) { isScrolling = false; return; }
        handler(e);
      });
    };

    const getThumb = item => {
      if (!item) return null;
      if (item.thumbnail?.url) return item.thumbnail.url;
      if (item.thumbnails?.length) return item.thumbnails[0].url;
      return null;
    };

    const createShimmerBox = (w, h, r, mb = '0') => {
      const el = document.createElement('div');
      el.className = 'shimmer';
      el.style.cssText = `width:${w};height:${h};border-radius:${r};margin-bottom:${mb};flex-shrink:0`;
      return el;
    };

    const syncSpacers = () => {
      const homeBar = document.getElementById('homeTopBar');
      const spacerHome = document.querySelector('#homeView .header-spacer');
      if (homeBar && spacerHome) spacerHome.style.height = homeBar.offsetHeight + 'px';
      const exploreView = document.getElementById('exploreView');
      const spacerExplore = exploreView?.querySelector('.header-spacer');
      const exploreHeader = exploreView?.querySelector('.fixed-header');
      if (exploreHeader && spacerExplore) spacerExplore.style.height = exploreHeader.offsetHeight + 'px';
      const searchView = document.getElementById('searchView');
      const spacerSearch = searchView?.querySelector('.header-spacer');
      const searchHeader = searchView?.querySelector('.fixed-header');
      if (searchHeader && spacerSearch) spacerSearch.style.height = searchHeader.offsetHeight + 'px';
    };

    const App = {
      currentView: 'home',
      previousView: 'home',
      viewHistory: [],
      views: {},
      header: null,
      actions: null,
      headerTitle: null,
      currentTitle: '',
      exploreDataLoaded: false,
      lastScrollY: 0,
      floatingPlay: null,

      init() {
        this.views.home = document.getElementById('homeView');
        this.views.explore = document.getElementById('exploreView');
        this.views.detail = document.getElementById('detailView');
        this.views.search = document.getElementById('searchView');
        this.header = document.querySelector('.detail-nav');
        this.actions = document.querySelector('.detail-actions');
        this.headerTitle = document.getElementById('detailHeaderTitle');
        this.floatingPlay = document.getElementById('floatingPlay');
        this.showView('home');
        this.setupBackButton();
        this.setupScrollListener();
        this.setupNavigation();
        syncSpacers();
        document.fonts.ready.then(syncSpacers);
      },

      setupNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          addTapHandler(item, () => {
            const view = item.getAttribute('data-view');
            if (view === 'library') return;
            navItems.forEach(n => {
              n.classList.remove('active');
              const v = n.getAttribute('data-view');
              const icon = n.querySelector('i');
              if (iconStates[v]) icon.className = iconStates[v].outline;
            });
            item.classList.add('active');
            const icon = item.querySelector('i');
            if (iconStates[view]) icon.className = iconStates[view].filled;
            this.viewHistory = [];
            if (view === 'explore' && !this.exploreDataLoaded) {
              this.showView('explore');
              this.loadExploreData();
            } else {
              this.showView(view);
            }
          });
        });
      },

      async loadExploreData() {
        const container = document.getElementById('exploreContent');
        createShimmer(container);
        try {
          const res = await fetch(`${API}/explore`);
          if (!res.ok) throw new Error('Explore failed');
          const data = await res.json();
          this.exploreDataLoaded = true;
          this.renderContent(data.sections, container);
          syncSpacers();
        } catch (e) { console.error(e); }
      },

      renderContent(sections, container) {
        container.innerHTML = '';
        sectionItemCounters = {};
        if (!sections?.length) return;
        sections.forEach(section => {
          if (!section.title && !section.items?.length) return;
          const sectionEl = document.createElement('section');
          sectionEl.className = 'section';
          if (section.title) {
            const headerEl = document.createElement('div');
            headerEl.className = 'section-header';
            if (section.subtitle) {
              const subtitleEl = document.createElement('p');
              subtitleEl.className = 'section-subtitle';
              subtitleEl.textContent = section.subtitle;
              headerEl.appendChild(subtitleEl);
            }
            const titleEl = document.createElement('h2');
            titleEl.className = 'section-title';
            titleEl.textContent = section.title;
            headerEl.appendChild(titleEl);
            sectionEl.appendChild(headerEl);
          }
          if (section.items?.length) {
            const itemsEl = document.createElement('div');
            itemsEl.className = 'section-items';
            const sectionKey = section.title || 'untitled';
            if (!sectionItemCounters[sectionKey]) sectionItemCounters[sectionKey] = 0;
            section.items.forEach(item => {
              sectionItemCounters[sectionKey]++;
              const itemNumber = sectionItemCounters[sectionKey];
              const card = document.createElement('div');
              card.className = 'item-card';
              addTapHandler(card, () => {
                if (item.type === 'playlist' || item.type === 'album') {
                  const id = item.playlistId || item.browseId;
                  if (id) openPlaylist(id, itemNumber);
                }
              });
              const thumbUrl = getThumb(item);
              if (thumbUrl) {
                const img = document.createElement('img');
                img.className = 'item-image';
                img.src = thumbUrl;
                img.alt = item.title || '';
                img.loading = 'lazy';
                img.onerror = () => {
                  img.remove();
                  card.insertBefore(createShimmerBox('var(--thumb-md)', 'var(--thumb-md)', 'var(--radius-md)', 'var(--space-3)'), card.firstChild);
                };
                card.appendChild(img);
              } else {
                card.appendChild(createShimmerBox('var(--thumb-md)', 'var(--thumb-md)', 'var(--radius-md)', 'var(--space-3)'));
              }
              const infoEl = document.createElement('div');
              infoEl.className = 'item-info';
              if (item.title) {
                const titleEl = document.createElement('div');
                titleEl.className = 'item-title';
                titleEl.textContent = item.title;
                infoEl.appendChild(titleEl);
              }
              if (item.subtitle) {
                const metaEl = document.createElement('div');
                metaEl.className = 'item-meta';
                if (item.explicit) {
                  const badge = document.createElement('span');
                  badge.className = 'explicit-badge';
                  badge.textContent = 'E';
                  metaEl.appendChild(badge);
                }
                const metaText = document.createElement('span');
                metaText.className = 'item-meta-text';
                metaText.textContent = item.subtitle;
                metaEl.appendChild(metaText);
                infoEl.appendChild(metaEl);
              }
              card.appendChild(infoEl);
              itemsEl.appendChild(card);
            });
            sectionEl.appendChild(itemsEl);
          }
          container.appendChild(sectionEl);
        });
      },

      setupBackButton() {
        addTapHandler(document.getElementById('backButton'), () => {
          if (this.viewHistory.length > 0) this.showView(this.viewHistory.pop(), true);
          else this.showView('home', true);
        });
      },

      setupScrollListener() {
        const homeTopBar = document.getElementById('homeTopBar');
        window.addEventListener('scroll', () => {
          const currentScrollY = window.scrollY;
          if (this.currentView === 'home') {
            homeTopBar?.classList.toggle('hidden', currentScrollY > this.lastScrollY && currentScrollY > 20);
          }
          if (this.currentView === 'detail') this.updateHeaderOpacity();
          this.lastScrollY = currentScrollY;
        });
      },

      updateHeaderOpacity() {
        if (!this.header) this.header = document.querySelector('.detail-nav');
        if (!this.actions) this.actions = document.querySelector('.detail-actions');
        if (!this.header || !this.actions) return;
        const scrollY = window.scrollY;
        const threshold = this.actions.offsetTop + this.actions.offsetHeight - this.header.offsetHeight;
        const opacity = Math.min(1, scrollY / Math.max(1, threshold));
        this.header.style.backgroundColor = `rgba(0,0,0,${opacity})`;
        if (this.headerTitle) this.headerTitle.style.opacity = opacity;
        if (this.floatingPlay) this.floatingPlay.classList.toggle('visible', opacity >= 1);
      },

      resetScroll() {
        window.scrollTo({ top: 0, left: 0, behavior: 'instant' });
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        this.lastScrollY = 0;
      },

      showView(viewName, isBack = false) {
        if (!isBack && this.currentView !== viewName) this.viewHistory.push(this.currentView);
        this.previousView = this.currentView;
        Object.keys(this.views).forEach(key => {
          this.views[key].style.display = key === viewName ? 'block' : 'none';
        });
        this.currentView = viewName;
        if (viewName === 'home') document.getElementById('homeTopBar').classList.remove('hidden');
        if (viewName !== 'detail' && this.floatingPlay) this.floatingPlay.classList.remove('visible');
        this.resetScroll();
        requestAnimationFrame(() => {
          this.resetScroll();
          syncSpacers();
          if (viewName === 'detail') this.updateHeaderOpacity();
        });
      }
    };

    const createTabsShimmer = () => {
      const container = document.getElementById('tabs');
      container.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const width = Math.floor(Math.random() * 50) + 70;
        const shimmer = document.createElement('div');
        shimmer.className = 'shimmer shimmer-tab';
        shimmer.style.width = `${width}px`;
        shimmer.style.flexShrink = '0';
        container.appendChild(shimmer);
      }
    };

    const createShimmer = container => {
      container.innerHTML = '';
      const viewportWidth = window.innerWidth;
      const itemsPerRow = Math.ceil((viewportWidth - 16) / 148);
      const totalItems = itemsPerRow + 2;
      for (let i = 0; i < 4; i++) {
        const section = document.createElement('div');
        section.className = 'section';
        const header = document.createElement('div');
        header.className = 'section-header';
        const title = document.createElement('div');
        title.className = 'shimmer shimmer-title';
        header.appendChild(title);
        section.appendChild(header);
        const items = document.createElement('div');
        items.className = 'section-items';
        for (let j = 0; j < totalItems; j++) {
          const card = document.createElement('div');
          card.className = 'item-card';
          card.appendChild(createShimmerBox('var(--thumb-md)', 'var(--thumb-md)', 'var(--radius-md)', 'var(--space-3)'));
          const info = document.createElement('div');
          info.className = 'item-info';
          const titleShimmer = document.createElement('div');
          titleShimmer.className = 'shimmer shimmer-text';
          titleShimmer.style.width = '100px';
          info.appendChild(titleShimmer);
          const artistShimmer = document.createElement('div');
          artistShimmer.className = 'shimmer shimmer-text-sm';
          artistShimmer.style.width = '72px';
          info.appendChild(artistShimmer);
          card.appendChild(info);
          items.appendChild(card);
        }
        section.appendChild(items);
        container.appendChild(section);
      }
    };

    const createDetailShimmer = () => {
      const bg = document.getElementById('detailBackground');
      const bgContainer = bg.parentElement;
      const coverContainer = document.getElementById('detailCoverContainer');
      const title = document.getElementById('detailTitle');
      const meta = document.getElementById('detailMeta');
      const trackList = document.getElementById('trackList');
      bgContainer.querySelectorAll('.shimmer').forEach(s => s.remove());
      coverContainer.innerHTML = '';
      bg.style.backgroundImage = 'none';
      bg.style.backgroundColor = 'transparent';
      const bgShimmer = document.createElement('div');
      bgShimmer.className = 'detail-bg-shimmer shimmer';
      bgContainer.insertBefore(bgShimmer, bg.nextSibling);
      coverContainer.appendChild(createShimmerBox('var(--thumb-lg)', 'var(--thumb-lg)', 'var(--radius-md)'));
      title.innerHTML = '';
      const titleShimmer = document.createElement('div');
      titleShimmer.className = 'shimmer';
      titleShimmer.style.cssText = 'width:180px;height:32px;border-radius:var(--radius-sm)';
      title.appendChild(titleShimmer);
      meta.innerHTML = '';
      const metaShimmer1 = document.createElement('div');
      metaShimmer1.className = 'shimmer';
      metaShimmer1.style.cssText = 'width:100%;height:18px;border-radius:var(--radius-sm);margin-bottom:var(--space-2)';
      meta.appendChild(metaShimmer1);
      const metaShimmer2 = document.createElement('div');
      metaShimmer2.className = 'shimmer';
      metaShimmer2.style.cssText = 'width:65%;height:18px;border-radius:var(--radius-sm)';
      meta.appendChild(metaShimmer2);
      const estimatedTracks = Math.ceil(window.innerHeight / 60) + 2;
      trackList.innerHTML = '';
      for (let i = 0; i < estimatedTracks; i++) {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) 0';
        row.appendChild(createShimmerBox('var(--thumb-sm)', 'var(--thumb-sm)', 'var(--radius-sm)'));
        const info = document.createElement('div');
        info.style.cssText = 'flex:1;min-width:0';
        const nameShimmer = document.createElement('div');
        nameShimmer.className = 'shimmer';
        nameShimmer.style.cssText = 'width:55%;height:20px;border-radius:var(--radius-sm);margin-bottom:2px';
        info.appendChild(nameShimmer);
        const artistShimmer = document.createElement('div');
        artistShimmer.className = 'shimmer';
        artistShimmer.style.cssText = 'width:35%;height:18px;border-radius:var(--radius-sm)';
        info.appendChild(artistShimmer);
        row.appendChild(info);
        trackList.appendChild(row);
      }
    };

    const openPlaylist = async (id, itemNumber) => {
      App.showView('detail');
      document.getElementById('trackList').innerHTML = '';
      createDetailShimmer();
      try {
        const res = await fetch(`${API}/browse/${id}`);
        if (!res.ok) return;
        showDetail(await res.json());
      } catch (e) { console.error(e); }
    };

    const showDetail = data => {
      App.currentTitle = data.title || '';
      if (App.headerTitle) App.headerTitle.innerText = App.currentTitle;
      const bg = document.getElementById('detailBackground');
      const bgContainer = bg.parentElement;
      const coverContainer = document.getElementById('detailCoverContainer');
      const title = document.getElementById('detailTitle');
      const meta = document.getElementById('detailMeta');
      const trackList = document.getElementById('trackList');
      bgContainer.querySelectorAll('.shimmer').forEach(s => s.remove());
      coverContainer.innerHTML = '';
      const thumbUrl = getThumb(data);
      if (thumbUrl) {
        const cover = document.createElement('img');
        cover.className = 'detail-cover';
        cover.src = thumbUrl;
        cover.alt = data.title || '';
        cover.onerror = () => {
          cover.remove();
          coverContainer.appendChild(createShimmerBox('var(--thumb-lg)', 'var(--thumb-lg)', 'var(--radius-md)'));
          const bgShimmer = document.createElement('div');
          bgShimmer.className = 'detail-bg-shimmer shimmer';
          bgContainer.insertBefore(bgShimmer, bg.nextSibling);
        };
        coverContainer.appendChild(cover);
        const bgImg = new Image();
        bgImg.src = thumbUrl;
        bgImg.onload = () => { bg.style.backgroundImage = `url('${thumbUrl}')`; };
      } else {
        coverContainer.appendChild(createShimmerBox('var(--thumb-lg)', 'var(--thumb-lg)', 'var(--radius-md)'));
        const bgShimmer = document.createElement('div');
        bgShimmer.className = 'detail-bg-shimmer shimmer';
        bgContainer.insertBefore(bgShimmer, bg.nextSibling);
      }
      title.innerHTML = '';
      title.textContent = data.title || '';
      meta.innerHTML = '';
      const desc = data.description || '';
      if (desc.length > 100) {
        let isExpanded = false;
        const renderDesc = () => {
          meta.innerHTML = '';
          meta.classList.toggle('expanded', isExpanded);
          if (isExpanded) {
            meta.textContent = desc + ' ';
            const btn = document.createElement('span');
            btn.className = 'detail-meta-expand';
            btn.textContent = 'Ver menos';
            meta.appendChild(btn);
            addTapHandler(btn, () => { isExpanded = false; renderDesc(); });
          } else {
            meta.textContent = desc;
            const lineHeight = parseFloat(getComputedStyle(meta).lineHeight);
            const maxHeight = lineHeight * 2;
            if (meta.scrollHeight > maxHeight) {
              let lo = 0, hi = desc.length, best = 0;
              while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                meta.textContent = desc.substring(0, mid) + '... Ver más';
                if (meta.scrollHeight <= maxHeight) { best = mid; lo = mid + 1; }
                else { hi = mid - 1; }
              }
              const lastSpace = desc.substring(0, best).lastIndexOf(' ');
              meta.textContent = desc.substring(0, lastSpace > 0 ? lastSpace : best) + '... ';
              const btn = document.createElement('span');
              btn.className = 'detail-meta-expand';
              btn.textContent = 'Ver más';
              meta.appendChild(btn);
              addTapHandler(btn, () => { isExpanded = true; renderDesc(); });
            }
          }
        };
        renderDesc();
      } else { meta.textContent = desc; }
      trackList.innerHTML = '';
      if (data.tracks?.length) {
        data.tracks.forEach((track, i) => {
          const trackThumbUrl = getThumb(track);
          const trackHTML = `
            <div class="track-item">
              ${trackThumbUrl ? `<img src="${trackThumbUrl}" class="track-thumb" alt="" loading="lazy">` : `<div class="track-num">${i + 1}</div>`}
              <div class="track-info">
                <div class="track-name">${track.title || `Track ${i + 1}`}</div>
                <div class="track-artist">
                  ${track.explicit ? '<span class="explicit-badge">E</span>' : ''}
                  <span class="track-artist-text">${track.subtitle || ''}</span>
                </div>
              </div>
              <button class="track-menu" aria-label="Opciones" type="button">
                <i class="ph-bold ph-dots-three-vertical"></i>
              </button>
            </div>`;
          trackList.insertAdjacentHTML('beforeend', trackHTML);
        });
      }
    };

    const renderTabs = chips => {
      const container = document.getElementById('tabs');
      container.innerHTML = '';
      chips?.forEach(chip => {
        const tab = document.createElement('button');
        tab.className = 'tab' + ((chip.text === currentFilter || (currentFilter === null && chip.isSelected)) ? ' active' : '');
        tab.setAttribute('role', 'tab');
        tab.textContent = chip.text;
        addTapHandler(tab, () => {
          const allTabs = container.querySelectorAll('.tab');
          if (currentFilter === chip.text) {
            currentFilter = null;
            allTabs.forEach(t => t.classList.remove('active'));
            loadData(null);
          } else {
            currentFilter = chip.text;
            allTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadData(chip.text);
          }
        });
        container.appendChild(tab);
      });
    };

    const loadData = async filter => {
      if (document.getElementById('tabs').children.length === 0) createTabsShimmer();
      createShimmer(document.getElementById('content'));
      try {
        const url = filter ? `${API}/home?filter=${encodeURIComponent(filter)}` : `${API}/home`;
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        renderTabs(data.header?.chips || []);
        if (data.sections) App.renderContent(data.sections, document.getElementById('content'));
        syncSpacers();
      } catch (e) { console.error(e); }
    };

    App.init();
    loadData();
    window.addEventListener('resize', syncSpacers);
  </script>
</body>
</html>